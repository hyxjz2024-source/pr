<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>住戶公設回報</title>
  <style>
    :root{
      --bg:#f3f4fd; /* 淺紫色背景 */
      --card:#ffffff;
      --ink:#1e293b;
      --muted:#64748b;
      --brand:#6366f1; /* 藍紫色強調色 */
      --ok:#10b981;
      --warn:#f59e0b;
      --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      font-family:"Noto Sans TC",system-ui,-apple-system;
      padding: 20px;
    }
    .wrap{
      max-width:600px; /* 適合直式單欄 */
      margin:20px auto;
    }
    .card{
      background:var(--card);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(30, 41, 59, 0.1);
      padding:24px;
    }
    h1{margin:0 0 8px;font-size:26px;color:var(--ink)}
    p.sub{margin:0 0 16px;color:var(--muted);font-size:15px;}

    /* 欄位樣式 */
    label{display:block;margin:16px 0 6px;font-weight:700;color:var(--ink)}
    input,select,textarea{
      width:100%;
      padding:12px;
      border:1px solid #e0e7ff; 
      border-radius:10px;
      font-size:16px;
      background:#f8f9ff;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
        border-color: var(--brand);
        outline: none;
    }
    textarea{min-height:100px;resize:vertical}
    
    /* 按鈕樣式 */
    .btns{display:flex;gap:12px;margin-top:24px}
    button{
      appearance:none;border:0;border-radius:10px;padding:12px 20px;
      font-weight:700;cursor:pointer;flex-grow:1;
      transition: background-color 0.2s;
    }
    .primary{background:var(--brand);color:#fff}
    .primary:hover{background:#4f46e5}
    .ghost{background:#eef2ff;color:var(--ink)}
    .ghost:hover{background:#e0e7ff}

    /* 狀態訊息 */
    .status{margin-top:16px;padding:10px;border-radius:8px;}
    .ok{color:var(--ok);background:#ecfdf5;} 
    .warn{color:var(--warn);background:#fffbeb;} 
    .err{color:var(--err);background:#fef2f2;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>住戶公設回報1</h1>
      <p class="sub">請提供清楚描述與照片，我們將儘速處理。</p>

      <iframe name="upload_frame" id="upload_frame" style="display:none;"></iframe>

      <form id="reportForm"
            action="https://script.google.com/macros/s/AKfycbwwlQKvcB5vUEJ0OassULP1xABAx36iZ61ervAwbju-xvH5xI1sSye7LYO98YpjDRzYPw/exec"
            method="post" enctype="multipart/form-data"
            target="upload_frame">

        <label>回報人</label>
        <input name="reporter" placeholder="選填" />

        <label>聯絡方式</label>
        <input name="contact" placeholder="市內電話 或 手機 (選填)" />
        
        <label>回報時間</label>
        <input name="clientTime" id="clientTime" readonly />

        <label>地點</label>
        <select name="location" id="location" required>
          <option value="">— 請選擇 —</option>
          <option>A棟</option><option>B棟</option><option>C棟</option>
          <option>D棟</option><option>E棟</option>
          <option>大廳</option><option>停車場B1</option><option>停車場B2</option><option>停車場B3</option>
          <option>其他</option>
        </select>

        <div id="locNoteWrap" style="display:none">
          <label>地點說明（選「其他」才需填）</label>
          <input name="location_note" placeholder="請補充具體位置，如：E棟1F 垃圾間旁" />
        </div>

        <label>問題說明（最多 500 字）</label>
        <textarea name="description" id="description" required placeholder="請描述問題具體情況、是否影響安全、持續時間…"></textarea>

        <label>上傳照片（最多 5 張，單檔 ≤ 10MB）</label>
        <input type="file" name="photos[]" id="photos" accept="image/*" multiple />

        <div class="btns">
          <button type="button" class="ghost" id="btnReset">清除</button>
          <button type="submit" class="primary">送出回報</button>
        </div>
        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

  <script>
    // 時間顯示 (不變)
    const clientTimeEl = document.getElementById('clientTime');
    const fmt = d => new Intl.DateTimeFormat('zh-TW',{dateStyle:'medium', timeStyle:'short'}).format(d);
    const tick = ()=> clientTimeEl.value = fmt(new Date());
    tick(); setInterval(tick, 10000);

    // 「其他」→ 顯示地點說明 (不變)
    const sel = document.getElementById('location');
    const locNoteWrap = document.getElementById('locNoteWrap');
    sel.addEventListener('change', ()=>{ locNoteWrap.style.display = (sel.value==='其他')? 'block':'none'; });

    // 送出前做基本檢查（使用原生 form 上傳）
    const form = document.getElementById('reportForm');
    const statusEl = document.getElementById('status');
    const locNoteInput = form.location_note; // 取得地點說明 input 元素

    document.getElementById('btnReset').addEventListener('click', ()=> {
        form.reset();
        locNoteWrap.style.display = 'none'; // 重設「其他」欄位顯示狀態
    });

    form.addEventListener('submit', (e)=>{
      const files = document.getElementById('photos').files || [];
      if(!form.location.value){ e.preventDefault(); statusEl.textContent='請選擇地點。'; statusEl.className='status warn'; return; }
      if(form.location.value==='其他' && !locNoteInput.value.trim()){ e.preventDefault(); statusEl.textContent='請填寫地點說明。'; statusEl.className='status warn'; return; }
      if(!form.description.value.trim()){ e.preventDefault(); statusEl.textContent='請填寫問題說明。'; statusEl.className='status warn'; return; }
      if(files.length>5){ e.preventDefault(); statusEl.textContent='最多 5 張照片'; statusEl.className='status warn'; return; }
      for(const f of files){ if(f.size/1024/1024>10){ e.preventDefault(); statusEl.textContent=`照片 "${f.name}" 超過 10MB 限制。`; statusEl.className='status warn'; return; } }
      
      statusEl.textContent='上傳中…請稍候 (請勿關閉或刷新)';
      statusEl.className='status';
      
      // 在提交前禁用按鈕，防止重複提交
      document.querySelector('.primary').disabled = true;
    });

    // 接收 GAS 回傳（hidden iframe -> postMessage）
    window.addEventListener('message', (ev)=>{
      if(!ev.data || ev.data.source!=='gas') return;
      document.querySelector('.primary').disabled = false; // 重新啟用按鈕

      if(ev.data.success){
        statusEl.innerHTML = `✅ 已送出，案件編號：<b>${ev.data.caseId}</b>`;
        statusEl.className='status ok';
        form.reset();
        locNoteWrap.style.display = 'none'; // 重設「其他」欄位顯示狀態
        tick();
      }else{
        // 顯示更詳細的錯誤訊息
        let msg = ev.data.message || '未知錯誤';
        if(ev.data.debug && ev.data.debug.error) msg += ` (Debug: ${ev.data.debug.error.substring(0, 50)}...)`;
        statusEl.textContent = `上傳失敗：${msg}`;
        statusEl.className='status err';
      }
    });
  </script>
</body>
</html>
