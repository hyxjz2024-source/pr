<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="icon" type="image/x-icon" href="https://hyxjz.blogspot.com/favicon.ico">
  <title>æ–°åŠ å·ï½œå…¬è¨­å›å ±æŸ¥è©¢</title>
  <style>
    :root{
      --base-font: clamp(16px, 2.5vw, 18px);
      --font-lg: clamp(20px, 3vw, 24px);
      --font-xl: clamp(24px, 4vw, 28px);
      --ink:#0f172a;--muted:#6b7280;--card:#fff;--bg:#f6f9ff;
      --chip:#e6eeff;--chip-ink:#1e3a8a;--brand:#3b82f6;
      --radius: 12px;
      --pad-sm: clamp(8px, 2vw, 10px);
      --pad-md: clamp(12px, 2.5vw, 14px);
      --pad-lg: clamp(16px, 3vw, 20px);
      --gap-sm: clamp(8px, 2vw, 10px);
      --gap-md: clamp(12px, 2.5vw, 16px);
      --gap-lg: clamp(16px, 3vw, 20px);
    }
    html{font-size:var(--base-font)} *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#eef5ff,#f6f9ff);
      font-family:"Noto Sans TC",system-ui,-apple-system;
      line-height:1.6;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .wrap{
      max-width:min(800px, 100% - clamp(16px, 3vw, 24px));
      margin: var(--gap-md) auto;
      padding: var(--pad-md);
    }

    /* ä¿®æ”¹é ‚éƒ¨æ¨™é¡Œå€åŸŸ */
    .header{ 
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--gap-lg);
      position: relative;
    }

    .title-section {
      flex: 1;
    }

    h1{ 
      margin:0; 
      font-size:var(--font-xl); 
      color:var(--ink); 
      line-height:1.2;
      font-weight: 800;
    }

    /* ä¿®æ”¹æŒ‰éˆ•ä½ç½®åˆ°å³ä¸Šè§’ */
    .main-actions{ 
      position: absolute;
      top: 0;
      right: 0;
    }

    @media (max-width: 767px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--gap-md);
      }
      .main-actions {
        position: static;
        align-self: flex-end;
        margin-top: -50px; /* è®“æŒ‰éˆ•ä¸Šç§»é è¿‘æ¨™é¡Œ */
      }
    }

    .btn-primary{
      background:var(--brand); 
      color:#fff; 
      border:none; 
      border-radius:var(--radius);
      padding: var(--pad-sm) var(--pad-md);
      font-size:clamp(0.9rem, 2vw, 1rem);
      font-weight:600; 
      cursor:pointer; 
      transition:.2s;
      text-decoration:none; 
      display:inline-flex; 
      align-items:center; 
      justify-content:center; 
      gap:6px;
      white-space:nowrap;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(59,130,246,.4);
    }

    .controls{
      display:grid;
      grid-template-columns:1fr;
      gap:var(--gap-sm);
      margin-bottom:var(--gap-lg);
      background:rgba(255,255,255,.9);
      padding:var(--pad-md);
      border-radius:var(--radius);
      border: 1px solid #e5edff;
    }
    @media (min-width:640px){ 
      .controls{ 
        grid-template-columns:1fr 1fr; 
      } 
    }
    @media (min-width:1024px){ 
      .controls{ 
        grid-template-columns:1fr 2fr 1fr auto; 
      } 
    }
    .controls input, .controls select, .controls button{
      padding:var(--pad-md);
      border:1px solid #dce5ff;
      border-radius:var(--radius);
      background:#fff;
      font-size:clamp(0.9rem,2vw,1rem);
      font-weight:500;
      width:100%;
      transition:.2s;
    }
    .controls input:focus, .controls select:focus{
      outline:none; 
      border-color:var(--brand);
      box-shadow:0 0 0 2px rgba(59,130,246,.1);
    }
    .controls button{
      background:var(--chip); 
      color:var(--chip-ink);
      border:1px solid var(--chip); 
      cursor:pointer; 
      font-weight:600;
      white-space: nowrap;
    }
    .controls button:hover{ 
      background:var(--chip-ink); 
      color:#fff; 
      transform:translateY(-1px); 
    }

    .grid{display:block}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 4px 12px rgba(3,7,18,.06);
      padding:var(--pad-lg);
      margin-bottom:var(--gap-md);
      border: 1px solid #f1f5ff;
      transition:.2s;
    }
    .card:hover{ 
      transform:translateY(-1px); 
      box-shadow:0 6px 16px rgba(3,7,18,.1); 
      border-color: #e5edff;
    }

    .badge{
      display:inline-block;
      background:#eef2ff;
      border:1px solid #dbe4ff;
      color:#1e3a8a;
      font-weight:700;
      font-size:clamp(.8rem,1.8vw,.9rem);
      padding:var(--pad-sm) var(--pad-md);
      border-radius:8px;
      margin-bottom:var(--gap-sm);
    }

    /* ä¿®æ”¹ï¼šæ‰‹æ©Ÿç‰ˆä¹Ÿä¿æŒæ°´å¹³å°é½Š */
    .case-item{
      display: flex;
      flex-direction: column;
      gap: var(--gap-sm);
    }

    .case-row{
      display: flex;
      flex-direction: row; /* æ‰‹æ©Ÿç‰ˆä¹Ÿä¿æŒæ°´å¹³æ’åˆ— */
      align-items: flex-start;
      gap: var(--gap-sm);
      margin-bottom: var(--gap-sm);
    }

    .case-label{ 
      min-width: 5.5em; /* ç¨å¾®å¢åŠ æœ€å°å¯¬åº¦ç¢ºä¿å°é½Š */
      color:var(--muted); 
      font-weight:600; 
      font-size:clamp(.85rem,1.8vw,.95rem);
      flex-shrink: 0;
      text-align: right; /* æ–‡å­—å³å°é½Šæ›´æ•´é½Š */
      padding-top: 2px; /* å¾®èª¿å‚ç›´å°é½Š */
    }

    .case-value{ 
      color:#111827; 
      font-size:clamp(.95rem,2.2vw,1.1rem); 
      font-weight:500; 
      flex:1;
      line-height: 1.5;
    }

    .case-id{
      font-size:clamp(1.1rem,2.5vw,1.3rem);
      color:var(--brand);
      font-weight: 700;
    }

    .case-location{
      display: flex;
      gap: var(--gap-sm);
      flex-wrap: wrap;
    }

    .location-chip{ 
      background:var(--chip); 
      color:var(--chip-ink); 
      padding:6px 12px; 
      border-radius:20px; 
      font-weight:600; 
      font-size:clamp(.8rem,1.8vw,.9rem);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .case-description{
      font-size:clamp(.95rem,2.2vw,1.1rem);
      color:#111827;
      line-height:1.6;
      background: #f8faff;
      padding: var(--pad-md);
      border-radius: 8px;
      border-left: 3px solid var(--brand);
      margin-top: 2px; /* å¾®èª¿å°é½Š */
    }

    .thumbs{ 
      display:flex; 
      gap:var(--gap-sm); 
      flex-wrap:wrap; 
      margin-top:var(--gap-md);
      padding-top: var(--gap-sm);
      border-top: 1px solid #f1f5ff;
    }
    .thumbs img{ 
      width:clamp(80px,18vw,100px); 
      height:clamp(80px,18vw,100px); 
      object-fit:cover; 
      border-radius:8px; 
      border:1px solid #e5edff; 
      cursor:pointer; 
      transition:.2s; 
    }
    .thumbs img:hover{ 
      transform:scale(1.03); 
      border-color:var(--brand); 
    }

    .empty{ 
      padding:var(--pad-lg); 
      color:#64748b; 
      text-align:center; 
      font-size:clamp(1rem,2.2vw,1.1rem);
      background: #f8faff;
      border-radius: var(--radius);
      border: 1px solid #e5edff;
    }

    .footer{ 
      margin-top:var(--gap-lg); 
      color:#94a3b8; 
      font-size:clamp(.8rem,1.8vw,.9rem); 
      text-align:center; 
      padding:var(--pad-md);
    }

    .pager{ 
      display:flex; 
      gap:var(--gap-sm); 
      flex-wrap:wrap; 
      align-items:center; 
      justify-content:center; 
      margin:var(--gap-lg) 0; 
    }
    .pager button{ 
      padding:var(--pad-sm) var(--pad-md); 
      border:1px solid #dbe4ff; 
      border-radius:8px; 
      background:#fff; 
      min-width:clamp(40px,6vw,44px); 
      font-weight:600; 
      font-size:clamp(.85rem,1.8vw,.9rem); 
      cursor:pointer; 
      transition:.2s; 
    }
    .pager button:hover:not([disabled]){ 
      background:var(--chip); 
      border-color:var(--brand); 
    }
    .pager button[disabled]{ 
      opacity:.4; 
      cursor:not-allowed; 
    }
    .pager .now{ 
      background:#e6eeff; 
      border-color:#cfe0ff; 
      color: var(--chip-ink); 
    }

    .loading{ 
      display:inline-block; 
      width:16px; 
      height:16px; 
      border:2px solid #f3f3f3; 
      border-top:2px solid var(--brand); 
      border-radius:50%; 
      animation:spin 1s linear infinite; 
    }
    @keyframes spin{ 
      0%{ transform:rotate(0deg) } 
      100%{ transform:rotate(360deg) } 
    }

    /* è§¸æ§è£ç½®å„ªåŒ– */
    @media (hover: none) {
      .btn-primary, .controls button, .pager button {
        min-height: 44px;
      }
      .card:hover {
        transform: none;
      }
    }

    /* è¶…å°æ‰‹æ©Ÿçš„å¾®èª¿ */
    @media (max-width: 360px) {
      .case-row {
        gap: 6px;
      }
      .case-label {
        min-width: 5em;
        font-size: 0.8rem;
      }
      .case-value {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ä¿®æ”¹å¾Œçš„é ‚éƒ¨æ¨™é¡Œå€åŸŸ -->
    <div class="header">
      <div class="title-section">
        <h1>æ–°åŠ å·ï½œå…¬è¨­å›å ±æŸ¥è©¢</h1>
      </div>
      <div class="main-actions">
        <a class="btn-primary" id="btnBack" href="#" target="_blank" rel="noopener">ğŸ“ æˆ‘è¦å›å ±</a>
      </div>
    </div>

    <div class="controls">
      <select id="locFilter" aria-label="åœ°é»ç¯©é¸"><option value="">å…¨éƒ¨åœ°é»</option></select>
      <input id="q" placeholder="æœå°‹ï¼šç·¨è™Ÿã€åœ°é»ã€å•é¡Œé—œéµå­—" aria-label="æœå°‹" />
      <select id="pageSize" aria-label="æ¯é ç­†æ•¸">
        <option value="10" selected>æ¯é  10 ç­†</option>
        <option value="20">æ¯é  20 ç­†</option>
        <option value="50">æ¯é  50 ç­†</option>
      </select>
      <button id="btnReload">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </div>

    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œæˆ–é—œéµå­—ï¼ç¯©é¸æ¢ä»¶éæ–¼åš´æ ¼ã€‚</div>
    <div id="pager" class="pager" aria-label="åˆ†é "></div>

    <div class="footer">ç‚ºä¿è­·éš±ç§ï¼Œæœ¬é ä¸é¡¯ç¤ºå›å ±äººã€è¯çµ¡æ–¹å¼èˆ‡ä½æˆ¶åˆ¥ã€‚</div>
  </div>

  <script>
    const API_URL  = "https://script.google.com/macros/s/AKfycbyEuG_5s5RhDD5fHPafkkneTb4lEkgah7xTS1Y_A3HBK468aAM89GxfDxZPWQn310Lq/exec";
    const FORM_URL = "https://script.google.com/macros/s/AKfycbyEuG_5s5RhDD5fHPafkkneTb4lEkgah7xTS1Y_A3HBK468aAM89GxfDxZPWQn310Lq/exec";

    document.getElementById('btnBack').href = "https://sites.google.com/view/hyxjz";

    const elList   = document.getElementById('list');
    const elEmpty  = document.getElementById('empty');
    const elLoc    = document.getElementById('locFilter');
    const elQ      = document.getElementById('q');
    const elReload = document.getElementById('btnReload');
    const elPageSz = document.getElementById('pageSize');
    const elPager  = document.getElementById('pager');

    let ALL = [];
    let FILTERED = [];
    let page = 1;

    function escapeHtml(s){
      return String(s||'')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    function renderPage(items, pageSize){
      elList.innerHTML = '';
      if (!items.length) { 
        elEmpty.style.display='block'; 
        elPager.innerHTML=''; 
        return; 
      }
      elEmpty.style.display='none';

      const total = items.length;
      const pages = Math.max(1, Math.ceil(total / pageSize));
      page = Math.max(1, Math.min(page, pages));

      const start = (page - 1) * pageSize;
      const end   = Math.min(start + pageSize, total);
      const slice = items.slice(start, end);

      slice.forEach((it, idx) => {
        const rowNo = start + idx + 1;
        const card = document.createElement('div');
        card.className = 'card';

        const locationChips = [];
        if (it.location) {
          locationChips.push(`<span class="location-chip">${escapeHtml(it.location)}</span>`);
        }
        if (it.location_note) {
          locationChips.push(`<span class="location-chip">${escapeHtml(it.location_note)}</span>`);
        }

        const thumbs = (it.images||[]).map(img => `
          <a href="${img.viewUrl}" target="_blank" rel="noopener">
            <img src="${img.thumbUrl}" alt="æ¡ˆä»¶ç…§ç‰‡" loading="lazy">
          </a>
        `).join('');

        card.innerHTML = `
          <div class="case-item">
            <div class="badge">æ¡ˆä»¶${rowNo}</div>
            
            <div class="case-row">
              <div class="case-label">æ¡ˆä»¶ç·¨è™Ÿï¼š</div>
              <div class="case-value case-id"># ${escapeHtml(it.caseId)}</div>
            </div>
            
            <div class="case-row">
              <div class="case-label">å›å ±æ™‚é–“ï¼š</div>
              <div class="case-value">${escapeHtml(it.time)}</div>
            </div>
            
            <div class="case-row">
              <div class="case-label">å›å ±åœ°é»ï¼š</div>
              <div class="case-value">
                <div class="case-location">${locationChips.join('')}</div>
              </div>
            </div>
            
            <div class="case-row">
              <div class="case-label">å•é¡Œèªªæ˜ï¼š</div>
              <div class="case-value case-description">${escapeHtml(it.description)}</div>
            </div>
            
            ${thumbs ? `
              <div class="thumbs" aria-label="ç›¸é—œç…§ç‰‡">
                ${thumbs}
              </div>
            ` : ''}
          </div>
        `;
        elList.appendChild(card);
      });

      // åˆ†é 
      elPager.innerHTML = '';
      const mk = (txt, disabled, fn, cls='')=>{
        const b=document.createElement('button'); 
        b.textContent=txt; 
        if(disabled) b.disabled=true; 
        b.className=cls; 
        b.onclick=fn; 
        return b;
      };
      
      const pagesTotal = Math.max(1, Math.ceil(FILTERED.length / pageSize));
      
      elPager.appendChild(mk('Â« æœ€å‰', page===1, ()=>{page=1; renderPage(FILTERED,pageSize)}));
      elPager.appendChild(mk('â€¹ ä¸Šé ', page===1, ()=>{page--; renderPage(FILTERED,pageSize)}));
      
      const show = 5;
      const startP = Math.max(1, page - Math.floor(show/2));
      const endP = Math.min(pagesTotal, startP + show - 1);
      
      for(let p = startP; p <= endP; p++) {
        elPager.appendChild(mk(String(p), false, ()=>{page=p; renderPage(FILTERED,pageSize)}, p===page?'now':''));
      }
      
      elPager.appendChild(mk('ä¸‹é  â€º', page>=pagesTotal, ()=>{page++; renderPage(FILTERED,pageSize)}));
      elPager.appendChild(mk('æœ€å¾Œ Â»', page>=pagesTotal, ()=>{page=pagesTotal; renderPage(FILTERED,pageSize)}));
    }

    function filter(){
      const q = (elQ.value || '').trim().toLowerCase();
      const loc = elLoc.value;
      FILTERED = ALL.filter(it => {
        const locOk = !loc || String(it.location||'') === loc;
        if (!locOk) return false;
        if (!q) return true;
        const hay = [(it.caseId||''),(it.location||''),(it.location_note||''),(it.description||'')].join('\n').toLowerCase();
        return hay.includes(q);
      });
      page = 1;
      renderPage(FILTERED, Number(elPageSz.value||10));
    }

    function buildLocationOptions(){
      const set = new Set();
      ALL.forEach(it => { if (it.location) set.add(String(it.location)); });
      const list = Array.from(set).sort((a,b)=>a.localeCompare(b,'zh-Hant'));
      elLoc.innerHTML = `<option value="">å…¨éƒ¨åœ°é»</option>` + list.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
    }

    function loadViaFetch(){
      const url = `${API_URL}?api=public&limit=500&_=${Date.now()}`;
      return fetch(url)
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(data => { 
          ALL = data || []; 
          buildLocationOptions(); 
          filter(); 
        });
    }

    function loadViaJSONP(){
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        window[cb] = (data) => {
          try {
            ALL = data || [];
            buildLocationOptions(); 
            filter();
            resolve();
          } finally {
            delete window[cb]; 
            s.remove();
          }
        };
        const s = document.createElement('script');
        s.src = `${API_URL}?api=public&limit=500&callback=${cb}&_=${Date.now()}`;
        s.onerror = () => { 
          delete window[cb]; 
          s.remove(); 
          reject(new Error('JSONP è¼‰å…¥å¤±æ•—')); 
        };
        document.head.appendChild(s);
      });
    }

    function load(){
      elList.innerHTML = '<div class="empty"><div class="loading"></div> è¼‰å…¥ä¸­â€¦</div>';
      elReload.disabled = true; 
      elReload.textContent = 'è¼‰å…¥ä¸­â€¦';
      
      loadViaFetch()
        .catch(() => loadViaJSONP())
        .catch(err => {
          console.error(err);
          elList.innerHTML = '<div class="empty">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>';
        })
        .finally(() => {
          elReload.disabled = false;
          elReload.textContent = 'ğŸ”„ é‡æ–°è¼‰å…¥';
        });
    }

    elQ.addEventListener('input', filter);
    elLoc.addEventListener('change', filter);
    elReload.addEventListener('click', load);
    elPageSz.addEventListener('change', ()=>{ 
      page=1; 
      renderPage(FILTERED, Number(elPageSz.value||10)); 
    });

    load();
  </script>
</body>
</html>
